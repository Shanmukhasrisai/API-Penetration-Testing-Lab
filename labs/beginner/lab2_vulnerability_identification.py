#!/usr/bin/env python3
"""
API Penetration Testing Lab - Beginner Lab 2: Vulnerability Identification

Topics: Identifying common API vulnerabilities, parameter tampering, info disclosure
Difficulty: Beginner
"""

import requests
import json
from urllib.parse import urljoin, quote
from typing import Dict, List, Any

BASE_URL = "http://localhost:5000/api"

class VulnerabilityIdentificationLab:
    """Lab for identifying common API vulnerabilities"""
    
    def __init__(self):
        self.session = requests.Session()
        self.base_url = BASE_URL
        self.vulnerabilities_found = []
    
    # EXERCISE 1: Information Disclosure
    def exercise_1_information_disclosure(self):
        """
        Exercise 1: Identify information disclosure vulnerabilities
        
        Learning Goals:
        - Recognize verbose error messages
        - Identify sensitive data in responses
        - Understand overly detailed API responses
        
        Tasks:
        1. Trigger error messages
        2. Analyze error details
        3. Look for sensitive information
        """
        print("\n=== Exercise 1: Information Disclosure ===")
        
        # Task 1: Invalid input to trigger errors
        print("\n[Task 1] Testing error message verbosity...")
        test_payloads = [
            {"id": "invalid"},
            {"id": "' OR '1'='1"},
            {"id": "<script>alert('xss')</script>"},
        ]
        
        for payload in test_payloads:
            try:
                response = self.session.get(
                    urljoin(self.base_url, "/users"),
                    params=payload
                )
                if response.status_code >= 400:
                    print(f"\n[!] Potential info disclosure:")
                    print(f"    Payload: {payload}")
                    print(f"    Status: {response.status_code}")
                    print(f"    Response: {response.text[:300]}")
                    self.vulnerabilities_found.append("Information Disclosure")
            except Exception as e:
                pass
        
        # Task 2: Check for sensitive data in successful responses
        print("\n[Task 2] Checking for sensitive data in responses...")
        try:
            response = self.session.get(urljoin(self.base_url, "/users"))
            if response.status_code == 200:
                data = response.text
                sensitive_patterns = [
                    ("password", "Password field"),
                    ("secret", "Secret field"),
                    ("api_key", "API Key field"),
                    ("token", "Token field"),
                    ("credit_card", "Credit card data"),
                ]
                
                for pattern, description in sensitive_patterns:
                    if pattern.lower() in data.lower():
                        print(f"[!] Found potentially exposed: {description}")
                        self.vulnerabilities_found.append("Sensitive Data Exposure")
        except Exception as e:
            pass
    
    # EXERCISE 2: Broken Object Level Authorization (BOLA)
    def exercise_2_bola(self):
        """
        Exercise 2: Identify Broken Object Level Authorization
        
        Learning Goals:
        - Understand BOLA/IDOR vulnerabilities
        - Test sequential ID access
        - Identify missing authorization checks
        
        Tasks:
        1. Test sequential ID access
        2. Attempt accessing other users' data
        3. Verify authorization is enforced
        """
        print("\n=== Exercise 2: Broken Object Level Authorization (BOLA) ===")
        
        print("\n[Task 1] Testing sequential ID access...")
        for user_id in range(1, 6):
            try:
                response = self.session.get(
                    urljoin(self.base_url, f"/users/{user_id}")
                )
                if response.status_code == 200:
                    print(f"[+] User ID {user_id}: Accessible")
                    data = response.json()
                    if isinstance(data, dict) and "email" in data:
                        print(f"    Email: {data.get('email', 'N/A')}")
                        self.vulnerabilities_found.append("BOLA/IDOR")
                elif response.status_code == 401:
                    print(f"[-] User ID {user_id}: Requires authentication")
                elif response.status_code == 403:
                    print(f"[-] User ID {user_id}: Forbidden")
                elif response.status_code == 404:
                    print(f"[-] User ID {user_id}: Not found")
            except Exception as e:
                pass
    
    # EXERCISE 3: Parameter Tampering
    def exercise_3_parameter_tampering(self):
        """
        Exercise 3: Identify parameter tampering vulnerabilities
        
        Learning Goals:
        - Understand how parameters affect behavior
        - Test parameter manipulation
        - Identify lack of server-side validation
        
        Tasks:
        1. Modify query parameters
        2. Change request values
        3. Test edge cases
        """
        print("\n=== Exercise 3: Parameter Tampering ===")
        
        print("\n[Task 1] Testing parameter modification...")
        params_to_test = [
            {"role": "admin"},
            {"admin": "true"},
            {"isAdmin": "1"},
            {"is_admin": "yes"},
            {"permission_level": "9999"},
        ]
        
        for params in params_to_test:
            try:
                response = self.session.post(
                    urljoin(self.base_url, "/users"),
                    json={
                        "username": "testuser",
                        "email": "test@example.com",
                        **params
                    }
                )
                if response.status_code == 201 or response.status_code == 200:
                    print(f"[!] Suspicious parameter accepted: {params}")
                    print(f"    Status: {response.status_code}")
                    print(f"    Response: {response.text[:150]}")
                    self.vulnerabilities_found.append("Parameter Tampering")
            except Exception as e:
                pass
        
        print("\n[Task 2] Testing type manipulation...")
        type_tests = [
            {"amount": "9999999"},
            {"quantity": "-1"},
            {"price": "0.01"},
            {"discount": "1000"},
        ]
        
        for test in type_tests:
            try:
                response = self.session.post(
                    urljoin(self.base_url, "/orders"),
                    json=test
                )
                if response.status_code in [200, 201]:
                    print(f"[!] Suspicious value accepted: {test}")
                    self.vulnerabilities_found.append("Parameter Tampering")
            except Exception:
                pass
    
    # EXERCISE 4: Excessive Data Exposure
    def exercise_4_excessive_data_exposure(self):
        """
        Exercise 4: Identify excessive data exposure
        
        Learning Goals:
        - Recognize APIs returning unnecessary data
        - Identify overly detailed responses
        - Understand data minimization principles
        
        Tasks:
        1. Analyze response content
        2. Identify unnecessary fields
        3. Look for internal data
        """
        print("\n=== Exercise 4: Excessive Data Exposure ===")
        
        print("\n[Task 1] Analyzing API response content...")
        try:
            response = self.session.get(urljoin(self.base_url, "/users"))
            if response.status_code == 200:
                data = response.json()
                
                unnecessary_fields = [
                    "internal_id",
                    "database_id",
                    "password_hash",
                    "salt",
                    "private_key",
                    "secret",
                    "debug_info",
                ]
                
                response_text = response.text.lower()
                for field in unnecessary_fields:
                    if field.lower() in response_text:
                        print(f"[!] Excessive data exposure: {field}")
                        self.vulnerabilities_found.append("Excessive Data Exposure")
        except Exception as e:
            pass
    
    # EXERCISE 5: Missing Rate Limiting
    def exercise_5_rate_limiting(self):
        """
        Exercise 5: Test for missing rate limiting
        
        Learning Goals:
        - Understand rate limiting importance
        - Test API rate limits
        - Identify missing protections
        
        Tasks:
        1. Send rapid requests
        2. Monitor for rate limiting headers
        3. Test throttling
        """
        print("\n=== Exercise 5: Rate Limiting ===")
        
        print("\n[Task 1] Testing for rate limiting...")
        print("Sending 10 rapid requests...")
        
        rate_limit_headers = [
            "X-RateLimit-Limit",
            "X-RateLimit-Remaining",
            "X-RateLimit-Reset",
            "RateLimit-Limit",
            "RateLimit-Remaining",
        ]
        
        rate_limited = False
        for i in range(10):
            try:
                response = self.session.get(urljoin(self.base_url, "/users"))
                
                if i == 0:
                    print("\nResponse headers related to rate limiting:")
                    for header in rate_limit_headers:
                        if header in response.headers:
                            print(f"  Found: {header}: {response.headers[header]}")
                            rate_limited = True
                
                if response.status_code == 429:
                    print(f"\n[+] Rate limiting detected at request {i+1}")
                    rate_limited = True
                    break
            except Exception:
                pass
        
        if not rate_limited:
            print("\n[!] No rate limiting detected - potential vulnerability")
            self.vulnerabilities_found.append("Missing Rate Limiting")
    
    # EXERCISE 6: Endpoint Enumeration
    def exercise_6_endpoint_enumeration(self):
        """
        Exercise 6: Enumerate API endpoints
        
        Learning Goals:
        - Discover all API endpoints
        - Identify hidden endpoints
        - Map API surface
        
        Tasks:
        1. Test common endpoints
        2. Look for admin endpoints
        3. Find version differences
        """
        print("\n=== Exercise 6: Endpoint Enumeration ===")
        
        endpoints_to_test = [
            "/users",
            "/products",
            "/orders",
            "/admin",
            "/admin/users",
            "/admin/settings",
            "/internal",
            "/internal/debug",
            "/debug",
            "/status",
        ]
        
        print("\n[Task 1] Testing for common endpoints...")
        found_endpoints = []
        for endpoint in endpoints_to_test:
            try:
                response = self.session.get(urljoin(self.base_url, endpoint))
                if response.status_code != 404:
                    print(f"[+] Found: {endpoint} (Status: {response.status_code})")
                    found_endpoints.append(endpoint)
            except Exception:
                pass
    
    def print_summary(self):
        """Print vulnerability summary"""
        print("\n" + "="*60)
        print("Vulnerability Summary")
        print("="*60)
        
        if self.vulnerabilities_found:
            unique_vulns = list(set(self.vulnerabilities_found))
            print(f"\nVulnerabilities found: {len(unique_vulns)}")
            for vuln in unique_vulns:
                print(f"  - {vuln}")
        else:
            print("\nNo vulnerabilities detected (or API is secure)")
    
    def run_all_exercises(self):
        """Run all exercises"""
        print("\n" + "="*60)
        print("API Penetration Testing Lab - Beginner Lab 2")
        print("Vulnerability Identification")
        print("="*60)
        
        self.exercise_1_information_disclosure()
        self.exercise_2_bola()
        self.exercise_3_parameter_tampering()
        self.exercise_4_excessive_data_exposure()
        self.exercise_5_rate_limiting()
        self.exercise_6_endpoint_enumeration()
        
        self.print_summary()
        
        print("\nNext Steps:")
        print("1. Analyze each vulnerability type")
        print("2. Understand the security implications")
        print("3. Move to Lab 3: Reconnaissance and Information Gathering")

if __name__ == "__main__":
    try:
        lab = VulnerabilityIdentificationLab()
        lab.run_all_exercises()
    except KeyboardInterrupt:
        print("\n\nLab interrupted by user.")
    except Exception as e:
        print(f"\nLab error: {e}")
